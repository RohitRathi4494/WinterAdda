<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Shop | Winter Adda</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles.css">
  <!-- Mailchimp -->
  <script
    id="mcjs">!function (c, h, i, m, p) { m = c.createElement(h), p = c.getElementsByTagName(h)[0], m.async = 1, m.src = i, p.parentNode.insertBefore(m, p) }(document, "script", "https://chimpstatic.com/mcjs-connected/js/users/c8e400b9ede436893def17f12/6795fe29f8bec48e6a2650739.js");</script>
</head>

<body>

  <header>
    <div class="logo-area">
      <img src="images/logo.png" alt="Winter Adda Logo">
      <span>Winter Adda</span>
    </div>

    <nav class="main-nav">
      <a href="products.html?gender=men">MEN</a>
      <a href="products.html?gender=women">WOMEN</a>
      <a href="products.html?gender=kids">KIDS</a>
      <a href="index.html">HOME</a>
    </nav>

    <div class="search-bar">
      <input type="text" placeholder="Search for products, brands and more" id="search-input">
    </div>

    <div class="utility-nav">
      <a href="login.html">
        <span class="icon">üë§</span>
        <span>Profile</span>
      </a>
      <a href="wishlist.html">
        <span class="icon">‚ô°</span>
        <span>Wishlist</span>
      </a>
      <a href="cart.html">
        <span class="icon">üõçÔ∏è</span>
        <span>Bag</span>
      </a>
    </div>
  </header>

  <div class="container">
    <h2 class="section-title">Winter Collection</h2>

    <div class="category-filter">
      <button class="filter-btn active" onclick="filterProducts('all', this)">All</button>
      <button class="filter-btn" onclick="filterProducts('jackets', this)">Jackets</button>
      <button class="filter-btn" onclick="filterProducts('hoodies', this)">Hoodies</button>
      <button class="filter-btn" onclick="filterProducts('sweaters', this)">Sweaters</button>
      <button class="filter-btn" onclick="filterProducts('thermals', this)">Thermals</button>
      <button class="filter-btn" onclick="filterProducts('boots', this)">Boots</button>
      <button class="filter-btn" onclick="filterProducts('accessories', this)">Accessories</button>
    </div>

    <div class="products-grid" id="products-grid">
      <!-- Products will be loaded here dynamically -->
      <p style="text-align:center; width:100%; grid-column: 1/-1;">Loading products...</p>
    </div>
  </div>

  <footer>
    ¬© 2025 Winter Adda. All rights reserved.
  </footer>

  <script src="script.js"></script>
  <script src="auth.js"></script>
  <script>
    // Load products on page load
    async function loadShopProducts(category = 'all') {
      const grid = document.getElementById('products-grid');
      grid.innerHTML = '<p style="text-align:center; width:100%; grid-column: 1/-1;">Loading...</p>';

      try {
        // Construct URL
        let url = `${API_URL.replace('/auth', '/products')}`;
        if (category !== 'all') {
          url += `?category=${category}`;
        }

        const res = await fetch(url);
        const products = await res.json();

        // Helper to resolve image URL
        function getImageUrl(path) {
          if (!path) return 'images/logo.png';
          if (path.startsWith('http')) return path;
          if (path.startsWith('uploads/') || path.includes('\\')) {
            const baseUrl = API_URL.replace('/api/auth', '');
            return `${baseUrl}/${path.replace(/\\/g, '/')}`;
          }
          return path;
        }

        if (products.length === 0) {
          grid.innerHTML = '<p style="text-align:center; width:100%; grid-column: 1/-1;">No products found in this category.</p>';
          return;
        }

        grid.innerHTML = products.map(p => `
                <div class="product-card">
                  <a href="product-detail.html?id=${p._id}" style="text-decoration:none; color:inherit;">
                    <img src="${getImageUrl(p.image)}" alt="${p.name}" onerror="this.src='images/logo.png'">
                    <h3>${p.name}</h3>
                  </a>
                  <p class="price">‚Çπ${p.price}</p>
                  <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="btn btn-outline" style="width:100%" onclick="addToWishlist('${p.name.replace(/'/g, "\\'")}', ${p.price}, '${getImageUrl(p.image).replaceAll('\\', '/')}')">‚ô° Wishlist</button>
                  </div>
                </div>
            `).join('');

      } catch (err) {
        console.error(err);
        grid.innerHTML = '<p style="text-align:center; width:100%; grid-column: 1/-1; color:red">Error loading products. Ensure backend is running.</p>';
      }
    }

    // Override the simpler local filterProducts from script.js with this API-based one
    window.filterProducts = function (category, btn) {
      // Update active button
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      if (btn) btn.classList.add('active');

      // Fetch products
      loadShopProducts(category);
    };

    // Initial load
    // Check if URL has category param (e.g. from Home page links)
    const urlParams = new URLSearchParams(window.location.search);
    const catParam = urlParams.get('category') || 'all';

    // Set active button
    if (catParam !== 'all') {
      // Try to find the button and activate it
      // Note: simple implementation, might not match text exactly if case differs
    }

    loadShopProducts(catParam);
  </script>
</body>

</html>