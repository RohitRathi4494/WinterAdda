<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Admin Panel | Winter Adda</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <style>
        .admin-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .product-form {
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 40px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        .btn-delete {
            background-color: #ff4d4d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .product-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .product-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .product-thumb {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
        }
    </style>
</head>

<body>

    <header>
        <div class="logo-area">
            <img src="images/logo.png" alt="Winter Adda Logo">
            <span>Winter Adda Admin</span>
        </div>
        <button class="hamburger" onclick="toggleMenu()">
            <span></span><span></span><span></span>
        </button>
        <nav class="main-nav">
            <a href="index.html">Home</a>
            <a href="products.html">Products</a>
        </nav>
    </header>

    <div class="admin-container">
        <div class="admin-header">
            <h1>Product Management</h1>
        </div>

        <div class="product-form">
            <h3 id="form-title">Add New Product</h3>
            <form onsubmit="saveProduct(event)">
                <input type="hidden" id="p-id">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Product Name</label>
                        <input type="text" id="p-name" required>
                    </div>
                    <div class="form-group">
                        <label>Price (₹)</label>
                        <input type="number" id="p-price" required>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="p-category" required>
                            <option value="jackets">Jackets</option>
                            <option value="hoodies">Hoodies</option>
                            <option value="sweaters">Sweaters</option>
                            <option value="thermals">Thermals</option>
                            <option value="boots">Boots</option>
                            <option value="accessories">Accessories</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Sizes (Select available)</label>
                        <div style="display: flex; gap: 15px; margin-top: 5px;">
                            <label><input type="checkbox" name="size" value="S"> S</label>
                            <label><input type="checkbox" name="size" value="M"> M</label>
                            <label><input type="checkbox" name="size" value="L"> L</label>
                            <label><input type="checkbox" name="size" value="XL"> XL</label>
                            <label><input type="checkbox" name="size" value="XXL"> XXL</label>
                        </div>
                    </div>


                    <!-- Color Picker Section -->
                    <div class="form-group">
                        <label>Product Colors (Pick Colors)</label>
                        <div id="color-picker-container"
                            style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                            <div class="color-input-wrapper" style="display: flex; gap: 5px; align-items: center;">
                                <input type="color" class="color-picker-input" value="#000000"
                                    style="width: 50px; height: 40px; border: 1px solid #ddd; cursor: pointer;">
                                <button type="button" class="remove-color-btn" onclick="removeColorInput(this)"
                                    style="display: none; padding: 5px 10px; background: #ff4444; color: white; border: none; border-radius: 4px; cursor: pointer;">✕</button>
                            </div>
                            <button type="button" onclick="addColorPicker()"
                                style="padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">+
                                Add Color</button>
                        </div>
                        <small style="color: #666; display: block; margin-top: 5px;">Click the color boxes to select
                            colors for this product</small>
                    </div>
                    <div class="form-group">
                        <label>Images (Max 4)</label>
                        <!-- CHANGED: multiple and name='images' -->
                        <input type="file" id="p-image-files" accept=".jpg, .jpeg, .png, .webp" multiple max="4">
                        <small style="display:block; color:#666; margin-top:5px;">Select up to 4 images. First one is
                            main.</small>
                    </div>
                </div>
                <div class="form-group">
                    <label>Description (Optional)</label>
                    <textarea id="p-desc" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="p-featured" style="width: auto;"> Featured on Homepage
                    </label>
                </div>
                <!-- Buttons -->
                <div style="display:flex; gap:10px;">
                    <button type="submit" class="btn" id="btn-save">Add Product</button>
                    <button type="button" class="btn-delete" id="btn-cancel" style="display:none; background:#999;"
                        onclick="resetForm()">Cancel Edit</button>
                </div>
            </form>
        </div>

        <h3>Existing Products</h3>
        <div id="product-list">
            <!-- Products loaded here -->
        </div>
    </div>

    <script src="auth.js"></script>
    <script>
        // Helper to resolve image URL
        // Helper to resolve image URL
        function getImageUrl(path) {
            if (!path) return 'images/logo.png';
            if (path.startsWith('http')) return path;
            // Force local images for stability
            const filename = path.split(/[/\\]/).pop();
            return `images/${filename}`;
        }

        // Check Admin Role
        async function verifyAdmin() {
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user || user.role !== 'admin') {
                alert('Access Denied. Admins only.');
                window.location.href = 'index.html';
                return;
            }
            loadProducts();
        }

        async function loadProducts() {
            try {
                const res = await fetch(`${API_URL.replace('/auth', '/products')}`);
                const products = await res.json();

                const list = document.getElementById('product-list');
                list.innerHTML = products.map(p => `
                <div class="product-list-item">
                    <div class="product-info">
                        <img src="${getImageUrl(p.image)}" class="product-thumb" onerror="this.src='images/logo.png'">
                        <div>
                            <strong>${p.name}</strong><br>
                            <span style="font-size:12px; color:#666">${p.category} - ₹${p.price} ${p.isFeatured ? '<span style="color:#c94e7b; font-weight:bold;">[Featured]</span>' : ''}</span>
                        </div>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn" style="padding:5px 12px; font-size:12px;" onclick='editProduct(${JSON.stringify(p).replace(/'/g, "&#39;")})'>Edit</button>
                        <button class="btn-delete" onclick="deleteProduct('${p._id}')">Delete</button>
                    </div>
                </div>
            `).join('');
            } catch (err) {
                console.error(err);
            }
        }

        function resetForm() {
            document.getElementById('p-id').value = '';
            document.getElementById('p-name').value = '';
            document.getElementById('p-price').value = '';
            document.getElementById('p-category').value = 'jackets';
            document.getElementById('p-desc').value = '';
            document.getElementById('p-colors').value = '';
            document.getElementById('p-featured').checked = false;
            document.getElementById('p-image-files').value = ''; // Reset file input

            // Uncheck sizes
            document.querySelectorAll('input[name="size"]').forEach(cb => cb.checked = false);

            document.getElementById('form-title').innerText = 'Add New Product';
            document.getElementById('btn-save').innerText = 'Add Product';
            document.getElementById('btn-cancel').style.display = 'none';
        }

        function editProduct(product) {
            document.getElementById('p-id').value = product._id;
            document.getElementById('p-name').value = product.name;
            document.getElementById('p-price').value = product.price;
            document.getElementById('p-category').value = product.category;
            document.getElementById('p-desc').value = product.description || '';
            document.getElementById('p-featured').checked = product.isFeatured;

            // Load colors into color pickers
            loadColorsForEdit(product.colors || []);

            // Check sizes
            document.querySelectorAll('input[name="size"]').forEach(cb => {
                cb.checked = product.sizes && product.sizes.includes(cb.value);
            });

            document.getElementById('form-title').innerText = 'Edit Product';
            document.getElementById('btn-save').innerText = 'Update Product';
            document.getElementById('btn-cancel').style.display = 'inline-block';

            // Scroll to form
            document.querySelector('.product-form').scrollIntoView({ behavior: 'smooth' });
        }

        async function saveProduct(e) {
            e.preventDefault();

            const id = document.getElementById('p-id').value;
            const imageFiles = document.getElementById('p-image-files').files;

            const productData = {
                name: document.getElementById('p-name').value,
                price: parseFloat(document.getElementById('p-price').value) || 0,
                category: document.getElementById('p-category').value,
                description: document.getElementById('p-desc').value,
                isFeatured: document.getElementById('p-featured').checked,
                sizes: Array.from(document.querySelectorAll('input[name="size"]:checked')).map(cb => cb.value),
                // Collect hex color codes from color pickers
                colors: Array.from(document.querySelectorAll('.color-picker-input')).map(input => input.value)
            };

            // Validation: Image is required ONLY for NEW products
            if (!id && imageFiles.length === 0) {
                alert('Please select at least one image for new products.');
                return;
            }

            const formData = new FormData();
            formData.append('name', name);
            formData.append('price', price);
            formData.append('category', category);
            formData.append('description', description);
            formData.append('isFeatured', isFeatured);

            // Append Images
            for (let i = 0; i < imageFiles.length; i++) {
                formData.append('images', imageFiles[i]);
            }

            // Send arrays as JSON strings
            formData.append('sizes', JSON.stringify(selectedSizes));
            const colorsArray = colorsInput.split(',').map(c => c.trim()).filter(c => c !== "");
            formData.append('colors', JSON.stringify(colorsArray));

            const token = localStorage.getItem('token');
            const isEdit = !!id;
            const url = isEdit
                ? `${API_URL.replace('/auth', '/products')}/${id}`
                : `${API_URL.replace('/auth', '/products')}`;
            const method = isEdit ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                if (res.ok) {
                    alert(isEdit ? 'Product Updated!' : 'Product Added!');
                    resetForm();
                    loadProducts();
                } else {
                    const text = await res.text();
                    try {
                        const d = JSON.parse(text);
                        alert(d.message || d.error || 'Error saving product');
                    } catch (e) {
                        alert(`Server Error: ${text}`);
                    }
                }
            } catch (err) {
                console.error(err);
                alert(`Connection Error: ${err.message}`);
            }
        }

        async function deleteProduct(id) {
            if (!confirm('Are you sure?')) return;

            const token = localStorage.getItem('token');
            try {
                const res = await fetch(`${API_URL.replace('/auth', '/products')}/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    loadProducts();
                } else {
                    alert('Error deleting product');
                }
            } catch (err) {
                console.error(err);
                alert('Connection Error');
            }
        }

        // Color Picker Helper Functions
        function addColorPicker() {
            const container = document.getElementById('color-picker-container');
            const addButton = container.querySelector('button[onclick="addColorPicker()"]');

            const newColorInput = document.createElement('div');
            newColorInput.className = 'color-input-wrapper';
            newColorInput.style.cssText = 'display: flex; gap: 5px; align-items: center;';
            newColorInput.innerHTML = `
                <input type="color" class="color-picker-input" value="#000000" style="width: 50px; height: 40px; border: 1px solid #ddd; cursor: pointer;">
                <button type="button" class="remove-color-btn" onclick="removeColorInput(this)" style="padding: 5px 10px; background: #ff4444; color: white; border: none; border-radius: 4px; cursor: pointer;">✕</button>
            `;

            container.insertBefore(newColorInput, addButton);
            updateRemoveButtons();
        }

        function removeColorInput(button) {
            button.closest('.color-input-wrapper').remove();
            updateRemoveButtons();
        }

        function updateRemoveButtons() {
            const wrappers = document.querySelectorAll('.color-input-wrapper');
            wrappers.forEach((wrapper, index) => {
                const removeBtn = wrapper.querySelector('.remove-color-btn');
                if (wrappers.length === 1) {
                    removeBtn.style.display = 'none';
                } else {
                    removeBtn.style.display = 'inline-block';
                }
            });
        }

        function loadColorsForEdit(colors) {
            const container = document.getElementById('color-picker-container');
            const addButton = container.querySelector('button[onclick="addColorPicker()"]');

            // Remove all existing color inputs
            document.querySelectorAll('.color-input-wrapper').forEach(wrapper => wrapper.remove());

            // Add color inputs for each stored color
            if (colors && colors.length > 0) {
                colors.forEach((hexColor, index) => {
                    const newColorInput = document.createElement('div');
                    newColorInput.className = 'color-input-wrapper';
                    newColorInput.style.cssText = 'display: flex; gap: 5px; align-items: center;';
                    newColorInput.innerHTML = `
                        <input type="color" class="color-picker-input" value="${hexColor}" style="width: 50px; height: 40px; border: 1px solid #ddd; cursor: pointer;">
                        <button type="button" class="remove-color-btn" onclick="removeColorInput(this)" style="padding: 5px 10px; background: #ff4444; color: white; border: none; border-radius: 4px; cursor: pointer;">✕</button>
                    `;
                    container.insertBefore(newColorInput, addButton);
                });
            } else {
                // Add one default color picker if no colors
                const newColorInput = document.createElement('div');
                newColorInput.className = 'color-input-wrapper';
                newColorInput.style.cssText = 'display: flex; gap: 5px; align-items: center;';
                newColorInput.innerHTML = `
                    <input type="color" class="color-picker-input" value="#000000" style="width: 50px; height: 40px; border: 1px solid #ddd; cursor: pointer;">
                    <button type="button" class="remove-color-btn" onclick="removeColorInput(this)" style="display: none; padding: 5px 10px; background: #ff4444; color: white; border: none; border-radius: 4px; cursor: pointer;">✕</button>
                `;
                container.insertBefore(newColorInput, addButton);
            }

            updateRemoveButtons();
        }

        document.addEventListener('DOMContentLoaded', verifyAdmin);
    </script>
</body>

</html>