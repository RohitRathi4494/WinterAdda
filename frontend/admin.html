<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Admin Panel | Winter Adda</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <style>
        .admin-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .product-form {
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 40px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        .btn-delete {
            background-color: #ff4d4d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .product-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .product-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .product-thumb {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
        }
    </style>
</head>

<body>

    <header>
        <div class="logo-area">
            <img src="images/logo.png" alt="Winter Adda Logo">
            <span>Winter Adda Admin</span>
        </div>
        <nav>
            <a href="index.html">Home</a>
            <a href="products.html">Products</a>
        </nav>
    </header>

    <div class="admin-container">
        <div class="admin-header">
            <h1>Product Management</h1>
        </div>

        <div class="product-form">
            <h3>Add New Product</h3>
            <form onsubmit="addProduct(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Product Name</label>
                        <input type="text" id="p-name" required>
                    </div>
                    <div class="form-group">
                        <label>Price (₹)</label>
                        <input type="number" id="p-price" required>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="p-category" required>
                            <option value="jackets">Jackets</option>
                            <option value="hoodies">Hoodies</option>
                            <option value="sweaters">Sweaters</option>
                            <option value="thermals">Thermals</option>
                            <option value="boots">Boots</option>
                            <option value="accessories">Accessories</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Image</label>
                        <!-- CHANGED: File input instead of text -->
                        <input type="file" id="p-image-file" accept="image/*">
                        <!-- Optional fallback if user wants to use URL -->
                        <input type="text" id="p-image-url" placeholder="Or enter Image URL"
                            style="margin-top:5px; display:none;">
                    </div>
                </div>
                <div class="form-group">
                    <label>Description (Optional)</label>
                    <textarea id="p-desc" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="p-featured" style="width: auto;"> Featured on Homepage
                    </label>
                </div>
                <button type="submit" class="btn">Add Product</button>
            </form>
        </div>

        <h3>Existing Products</h3>
        <div id="product-list">
            <!-- Products loaded here -->
        </div>
    </div>

    <script src="auth.js"></script>
    <script>
        // Helper to resolve image URL
        function getImageUrl(path) {
            if (!path) return 'images/logo.png';
            if (path.startsWith('http')) return path;
            if (path.startsWith('uploads/')) {
                // Construct base URL from API_URL (remove /api/auth)
                const baseUrl = API_URL.replace('/api/auth', '');
                return `${baseUrl}/${path.replace('\\', '/')}`;
            }
            return path;
        }

        // Check Admin Role
        async function verifyAdmin() {
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user || user.role !== 'admin') {
                alert('Access Denied. Admins only.');
                window.location.href = 'index.html';
                return;
            }
            loadProducts();
        }

        async function loadProducts() {
            try {
                const res = await fetch(`${API_URL.replace('/auth', '/products')}`);
                const products = await res.json();

                const list = document.getElementById('product-list');
                list.innerHTML = products.map(p => `
                <div class="product-list-item">
                    <div class="product-info">
                        <img src="${getImageUrl(p.image)}" class="product-thumb" onerror="this.src='images/logo.png'">
                        <div>
                            <strong>${p.name}</strong><br>
                            <span style="font-size:12px; color:#666">${p.category} - ₹${p.price} ${p.isFeatured ? '<span style="color:#c94e7b; font-weight:bold;">[Featured]</span>' : ''}</span>
                        </div>
                    </div>
                    <button class="btn-delete" onclick="deleteProduct('${p._id}')">Delete</button>
                </div>
            `).join('');
            } catch (err) {
                console.error(err);
            }
        }

        async function addProduct(e) {
            e.preventDefault();

            const name = document.getElementById('p-name').value;
            const price = document.getElementById('p-price').value;
            const category = document.getElementById('p-category').value;
            const desc = document.getElementById('p-desc').value;
            const isFeatured = document.getElementById('p-featured').checked;
            const fileInput = document.getElementById('p-image-file');

            const formData = new FormData();
            formData.append('name', name);
            formData.append('price', price);
            formData.append('category', category);
            formData.append('description', desc);
            formData.append('isFeatured', isFeatured);

            if (fileInput.files.length > 0) {
                formData.append('image', fileInput.files[0]);
            } else {
                // If we enabled URL fallback
                const urlInput = document.getElementById('p-image-url');
                if (urlInput && urlInput.value) {
                    formData.append('image', urlInput.value);
                } else {
                    alert('Please select an image file');
                    return;
                }
            }

            const token = localStorage.getItem('token');

            try {
                const res = await fetch(`${API_URL.replace('/auth', '/products')}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                        // Content-Type is NOT set manually when sending FormData, fetch sets it with boundary
                    },
                    body: formData
                });

                if (res.ok) {
                    alert('Product added!');
                    e.target.reset();
                    loadProducts();
                } else {
                    const d = await res.json();
                    alert(d.message || 'Error adding product');
                }
            } catch (err) {
                console.error(err);
                alert('Server error');
            }
        }

        async function deleteProduct(id) {
            if (!confirm('Are you sure?')) return;

            const token = localStorage.getItem('token');
            const res = await fetch(`${API_URL.replace('/auth', '/products')}/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (res.ok) {
                loadProducts();
            } else {
                alert('Error deleting');
            }
        }

        document.addEventListener('DOMContentLoaded', verifyAdmin);
    </script>
</body>

</html>